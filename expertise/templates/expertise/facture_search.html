{% extends 'expertise/layout.html' %}
{% block title %}Recherche de facture{% endblock %}
{% block page_icon %}üîç{% endblock %}
{% block page_title %}Rechercher une facture{% endblock %}
{% block page_subtitle %}Identifiez rapidement une facture et mettez √† jour son statut de paiement.{% endblock %}

{% block content %}
    <section class="card">
        <form method="get">
            <div class="form-grid">
                <div class="form-field">
                    <label for="facture-query">Num√©ro de facture</label>
                    <input id="facture-query" type="text" name="q" placeholder="Ex : CEPN-2025-001" value="{{ search_query }}">
                </div>
                <div class="actions">
                    <button type="submit">Rechercher</button>
                    {% if search_query %}
                        <a class="btn btn-secondary" href="{% url 'facture_search' %}">R√©initialiser</a>
                    {% endif %}
                </div>
            </div>
        </form>
    </section>

    <section class="card">
        <h2>Factures disponibles ({{ matches|length }})</h2>
        {% if matches %}
            <form method="get" class="form-grid">
                <input type="hidden" name="q" value="{{ search_query }}">
                <div class="form-field">
                    <label for="facture-select">Choisissez une facture</label>
                    <select id="facture-select" name="facture" onchange="this.form.submit()">
                        <option value="">-- S√©lectionner --</option>
                        {% for facture in matches %}
                            <option value="{{ facture.no_facture }}" {% if selected_facture and selected_facture.no_facture == facture.no_facture %}selected{% endif %}>
                                {{ facture.no_facture }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <noscript>
                    <div class="actions">
                        <button type="submit">Afficher</button>
                    </div>
                </noscript>
            </form>
        {% else %}
            <p class="empty-state">Aucune facture trouv√©e pour cette recherche.</p>
        {% endif %}
    </section>

    {% if selected_facture %}
        <section class="card">
            <h2>Facture {{ selected_facture.no_facture }}</h2>
            <div class="tags">
                <span class="tag">Total : {{ selected_facture.total }} XPF</span>
                <span class="tag {% if selected_facture.paiement %}tag--success{% else %}tag--danger{% endif %}">{{ statut_label }}</span>
            </div>
            <ul class="data-list data-list--spaced">
                <li class="data-list__item"><span class="data-list__label">Nom</span><span class="data-list__value">{{ selected_facture.personnel.nom }}</span></li>
                <li class="data-list__item"><span class="data-list__label">Pr√©nom</span><span class="data-list__value">{{ selected_facture.personnel.prenom }}</span></li>
                <li class="data-list__item"><span class="data-list__label">Compagnie</span><span class="data-list__value">{% if selected_facture.personnel.compagnie %}{{ selected_facture.personnel.compagnie.nom }}{% else %}‚Äî{% endif %}</span></li>
            </ul>
            <form method="post" action="{% url 'toggle_facture_paiement' selected_facture.pk %}" class="actions actions--top">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn {% if selected_facture.paiement %}btn-secondary{% endif %}">
                    {% if selected_facture.paiement %}‚úÖ Marquer en attente{% else %}üí∏ Marquer comme pay√©{% endif %}
                </button>
            </form>
        </section>
    {% endif %}
{% endblock %}

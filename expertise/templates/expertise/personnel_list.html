{% extends 'expertise/layout.html' %}
{% block title %}Personnels navigants{% endblock %}
{% block page_icon %}üßë‚Äç‚úàÔ∏è{% endblock %}
{% block page_title %}Liste des personnels navigants{% endblock %}
{% block page_subtitle %}Consulter, rechercher et g√©rer les dossiers CEPN.{% endblock %}

{% block extra_head %}
<style>
    .search-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }

    .weather-card {
        background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e');
        background-size: cover;
        color: #0b2c4a;
        position: relative;
    }

    .weather-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.75));
        border-radius: inherit;
        z-index: 0;
    }

    .weather-card__content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .weather-card__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .weather-card__close {
        background: rgba(11, 44, 74, 0.12);
        border-radius: 50%;
        width: 28px;
        height: 28px;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .weather-card__close:hover {
        transform: rotate(90deg);
    }

    .table-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
    }

    .search-field {
        flex: 1 1 280px;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const card = document.getElementById('weather-card');
    if (!card) {
        return;
    }
    const content = document.getElementById('weather-content');
    const closeBtn = document.getElementById('weather-close');
    const city = 'Papeete,PF';
    const apiKey = 'c1ffec6c4766b88a3e0df188a354923c';

    fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&units=metric&lang=fr&appid=${apiKey}`)
        .then(response => response.json())
        .then(data => {
            if (!data.weather) {
                throw new Error('Invalid weather payload');
            }
            const description = data.weather[0].description;
            const temp = Math.round(data.main.temp);
            const windSpeed = data.wind.speed;
            const windDeg = data.wind.deg;
            const directions = ['Nord', 'Nord-Est', 'Est', 'Sud-Est', 'Sud', 'Sud-Ouest', 'Ouest', 'Nord-Ouest'];
            const directionText = directions[Math.round(windDeg / 45) % 8];

            content.innerHTML = `üëã Bonjour Christian !<br>üå°Ô∏è <strong>${temp}¬∞C</strong> ‚Äî ${description}<br>üí® Vent : <strong>${windSpeed} m/s</strong> (${directionText})`;
            card.hidden = false;

            setTimeout(() => {
                card.hidden = true;
            }, 10000);
        })
        .catch(() => {
            content.textContent = '‚ùå Impossible de r√©cup√©rer la m√©t√©o.';
            card.hidden = false;
        });

    closeBtn.addEventListener('click', () => {
        card.hidden = true;
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('personnelTable');
    if (!table) {
        return;
    }
    const headers = table.querySelectorAll('th');
    const tbody = table.querySelector('tbody');

    headers.forEach(th => th.dataset.order = 'asc');

    headers.forEach((th, index) => {
        if (index === headers.length - 1) {
            return;
        }
        th.style.cursor = 'pointer';
        th.addEventListener('click', function() {
            const order = th.dataset.order;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isDateCol = th.textContent.trim() === 'Date de naissance';

            rows.sort((rowA, rowB) => {
                const aText = rowA.children[index].textContent.trim();
                const bText = rowB.children[index].textContent.trim();

                if (isDateCol) {
                    const [ad, am, ay] = aText.split('/');
                    const [bd, bm, by] = bText.split('/');
                    const aDate = new Date(ay, am - 1, ad);
                    const bDate = new Date(by, bm - 1, bd);
                    return order === 'asc' ? aDate - bDate : bDate - aDate;
                }

                const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
                if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
                    return order === 'asc' ? aNum - bNum : bNum - aNum;
                }

                return order === 'asc'
                    ? aText.localeCompare(bText, 'fr', { sensitivity: 'base' })
                    : bText.localeCompare(aText, 'fr', { sensitivity: 'base' });
            });

            rows.forEach(row => tbody.appendChild(row));
            th.dataset.order = order === 'asc' ? 'desc' : 'asc';
        });
    });
});
</script>
{% endblock %}

{% block content %}
    <section class="card weather-card" id="weather-card" hidden>
        <div class="weather-card__content">
            <div class="weather-card__header">
                <h2>M√©t√©o √† Papeete</h2>
                <button type="button" id="weather-close" class="weather-card__close">√ó</button>
            </div>
            <p id="weather-content">Chargement...</p>
        </div>
    </section>

    <section class="card">
        <form method="get">
            <div class="search-row">
                <div class="form-field search-field">
                    <label for="search-input">Rechercher un personnel</label>
                    <input id="search-input" type="text" name="q" placeholder="Nom, pr√©nom ou DN" value="{{ request.GET.q }}">
                </div>
                <div class="actions">
                    <button type="submit">Rechercher</button>
                    {% if request.GET.q %}
                        <a class="btn btn-secondary" href="{% url 'personnel_list' %}">R√©initialiser</a>
                    {% endif %}
                </div>
            </div>
        </form>
        <div class="actions actions--top">
            <a class="btn" href="{% url 'personnel_add' %}">Ajouter un personnel</a>
            <a class="btn btn-secondary" href="{% url 'selectionner_bordereau' %}">Cr√©er un bordereau</a>
            <a class="btn btn-secondary" href="{% url 'liste_bordereaux' %}">Consulter les bordereaux</a>
        </div>
    </section>

    <section class="card">
        <h2>R√©sultats</h2>
        <table id="personnelTable">
            <thead>
                <tr>
                    <th>DN</th>
                    <th>Nom</th>
                    <th>Pr√©nom</th>
                    <th>Date de naissance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for personnel in personnels %}
                    <tr>
                        <td>{{ personnel.dn }}</td>
                        <td>{{ personnel.nom }}</td>
                        <td>{{ personnel.prenom }}</td>
                        <td>{{ personnel.date_de_naissance|date:"d/m/Y" }}</td>
                        <td>
                            <div class="table-actions">
                                <a class="btn btn-secondary btn--small" href="{% url 'personnel_detail' personnel.dn %}">Historique</a>
                                <a class="btn btn-secondary btn--small" href="{% url 'personnel_edit' personnel.dn %}">Modifier</a>
                                <a class="btn btn-secondary btn--small" href="{% url 'personnel_delete' personnel.dn %}">Supprimer</a>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="empty-state">Aucun personnel trouv√©.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
{% endblock %}

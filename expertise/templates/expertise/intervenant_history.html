{% extends 'expertise/layout.html' %}
{% block title %}Historique intervenant{% endblock %}
{% block page_icon %}üìã{% endblock %}
{% block page_title %}Historique d'activit√©{% endblock %}
{% block page_subtitle %}{{ medecin.prenom }} {{ medecin.nom }} ‚Äî {{ medecin.specialite|default:'Sp√©cialit√© non renseign√©e' }}{% endblock %}

{% block content %}
    <section class="card">
        <div class="actions actions--spread">
            <div class="tags">
                <span class="tag">Total actes : {{ history|length }}</span>
                {% if pending_entries %}
                    <span class="tag tag--danger">{{ pending_entries|length }} acte(s) sans facture</span>
                {% endif %}
            </div>
            <div class="actions">
                <a class="btn btn-secondary btn--small" href="{% url 'intervenants_list' %}">Retour aux intervenants</a>
            </div>
        </div>
        {% if pending_entries %}
            <div class="actions actions--top">
                <a class="btn" href="{% url 'intervenant_history' medecin.id %}?autogen=1">G√©n√©rer une facture pour les actes √† facturer</a>
            </div>
        {% endif %}
    </section>

    {% if history %}
        <section class="card">
            <h2>R√©capitulatif financier</h2>
            <ul class="data-list data-list--spaced">
                <li class="data-list__item">
                    <span class="data-list__label">Montant brut (pay√©)</span>
                    <span class="data-list__value">{{ total_brut|floatformat:0 }} XPF</span>
                </li>
                <li class="data-list__item">
                    <span class="data-list__label">Redevances</span>
                    <span class="data-list__value">{{ total_redevance|floatformat:0 }} XPF</span>
                </li>
                <li class="data-list__item">
                    <span class="data-list__label">Montant net √† payer</span>
                    <span class="data-list__value">{{ total_net|floatformat:0 }} XPF</span>
                </li>
            </ul>
            {% if latest_invoice %}
                <p class="card__subtitle">Derni√®re facture m√©decin n¬∞ {{ latest_invoice.number }} √©mise le {{ latest_invoice.emission_date|date:"d/m/Y" }}.</p>
            {% else %}
                <p class="card__subtitle">Aucune facture m√©decin n'a encore √©t√© g√©n√©r√©e pour cet intervenant.</p>
            {% endif %}
        </section>

        {% if invoices %}
            <section class="card">
                <header class="actions actions--spread">
                    <h2>Factures g√©n√©r√©es</h2>
                    <a class="btn btn-secondary btn--small" href="{% url 'intervenant_invoice_all' medecin.id %}">T√©l√©charger toutes (ZIP)</a>
                </header>
                <ul class="data-list data-list--spaced">
                    {% for invoice in invoices %}
                        <li class="data-list__item">
                            <div>
                                <strong>{{ invoice.number }}</strong> ‚Äî {{ invoice.emission_date|date:"d/m/Y" }}
                                <span class="card__subtitle">Net {{ invoice.total_net|floatformat:0 }} XPF</span>
                            </div>
                            <div class="actions">
                                <a class="btn btn-secondary btn--small" href="{% url 'intervenant_invoice' medecin.id invoice.id %}">T√©l√©charger</a>
                                <form class="inline-form" method="post" action="{% url 'intervenant_invoice_delete' medecin.id invoice.id %}" onsubmit="return confirm('Supprimer cette facture m√©decin ?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn--small">Supprimer</button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </section>
        {% endif %}

        <section class="card">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Acte</th>
                        <th>Patient</th>
                        <th>Facture</th>
                        <th>Brut (XPF)</th>
                        <th>Redevance (XPF)</th>
                        <th>Net (XPF)</th>
                        <th>Statut</th>
                        <th>Facture m√©decin</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in history %}
                        <tr>
                            <td>{{ entry.date|date:"d/m/Y" }}</td>
                            <td>{{ entry.acte }}</td>
                            <td>{{ entry.patient_prenom }} {{ entry.patient_nom }}</td>
                            <td>
                                {% if entry.facture_no %}
                                    <a href="{% url 'facture' entry.facture_id %}">{{ entry.facture_no }}</a>
                                {% else %}
                                    <span class="tag">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ entry.montant_brut|floatformat:0 }}</td>
                            <td>{{ entry.redevance|floatformat:0 }}</td>
                            <td>{{ entry.montant_net|floatformat:0 }}</td>
                            <td>
                                <span class="tag {% if entry.paiement %}tag--success{% else %}tag--danger{% endif %}">
                                    {% if entry.paiement %}Pay√©e{% else %}Non pay√©e{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if entry.invoice_number and entry.invoice_id %}
                                    <a href="{% url 'intervenant_invoice' medecin.id entry.invoice_id %}">{{ entry.invoice_number }}</a>
                                {% elif entry.invoice_number %}
                                    {{ entry.invoice_number }}
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    {% else %}
        <section class="card">
            <p class="empty-state">Aucun acte enregistr√© pour ce m√©decin pour le moment.</p>
        </section>
    {% endif %}

{% endblock %}

{% block page_footer %}
    <section class="card page__footer-nav">
        <a class="btn btn-secondary btn--small" href="{% url 'intervenants_list' %}">Retour aux intervenants</a>
        <a class="btn btn-secondary btn--small" href="{% url 'accueil' %}">Retour √† l'accueil</a>
    </section>
{% endblock %}

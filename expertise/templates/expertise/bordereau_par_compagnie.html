{% extends 'expertise/layout.html' %}
{% block title %}Bordereaux par compagnie{% endblock %}
{% block page_icon %}üóÇÔ∏è{% endblock %}
{% block page_title %}Bordereaux par compagnie{% endblock %}
{% block page_subtitle %}Filtrer un transporteur, consulter les bordereaux et v√©rifier le statut des virements.{% endblock %}

{% block content %}
    <section class="card-grid">
        <article class="card">
            <h2>S√©lection de la compagnie</h2>
            <form method="get" class="selection-form">
                <label for="compagnie-select">Compagnie</label>
                <select id="compagnie-select" name="compagnie" onchange="this.form.submit()">
                    <option value="">-- S√©lectionner --</option>
                    {% for compagnie in compagnies %}
                        <option value="{{ compagnie.id }}" {% if selected_compagnie and compagnie.id == selected_compagnie.id %}selected{% endif %}>
                            {{ compagnie.nom }} ({{ compagnie.iata }})
                        </option>
                    {% endfor %}
                </select>
                <noscript>
                    <button type="submit" class="btn btn-secondary">Afficher</button>
                </noscript>
            </form>
        </article>

        {% if selected_compagnie %}
            <article class="card">
                <h2>Bordereaux disponibles</h2>
                {% if bordereaux %}
                    <form method="get" class="selection-form">
                        <input type="hidden" name="compagnie" value="{{ selected_compagnie.id }}">
                        <label for="bordereau-select">Num√©ro de bordereau</label>
                        <select id="bordereau-select" name="bordereau" onchange="this.form.submit()">
                            <option value="">-- S√©lectionner --</option>
                            {% for bordereau in bordereaux %}
                                <option value="{{ bordereau.id }}" {% if selected_bordereau and selected_bordereau.id == bordereau.id %}selected{% endif %}>
                                    {{ bordereau.no_bordereau }} ¬∑ {{ bordereau.date_bordereau|date:"d/m/Y" }}
                                </option>
                            {% endfor %}
                        </select>
                        <noscript>
                            <button type="submit" class="btn btn-secondary">Afficher</button>
                        </noscript>
                    </form>
                {% else %}
                    <p class="empty-state">Aucun bordereau trouv√© pour cette compagnie.</p>
                {% endif %}
            </article>
        {% endif %}
    </section>

    {% if selected_bordereau %}
        <section class="card">
            <header class="actions actions--spread">
                <div>
                    <h2>Bordereau {{ selected_bordereau.no_bordereau }}</h2>
                    <p class="page__subtitle"><strong>Date :</strong> {{ selected_bordereau.date_bordereau|date:"d/m/Y" }}</p>
                </div>
                <form method="post" action="{% url 'toggle_virement' selected_bordereau.id %}" class="inline-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="btn {% if selected_bordereau.virement %}btn-secondary{% endif %}">
                        {% if selected_bordereau.virement %}‚úÖ Virement effectu√©{% else %}üí∏ Marquer le virement{% endif %}
                    </button>
                </form>
            </header>

            <div class="tags">
                <span class="tag {% if selected_bordereau.virement %}tag--success{% else %}tag--danger{% endif %}">
                    Virement : {% if selected_bordereau.virement %}Effectu√©{% else %}Non effectu√©{% endif %}
                </span>
                {% if factures %}
                    <span class="tag">Total bordereau : {{ bordereau_total }} XPF</span>
                {% endif %}
            </div>

            <h3>Factures associ√©es</h3>
            {% if factures %}
                <table>
                    <thead>
                        <tr>
                            <th>Facture</th>
                            <th>DN</th>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>Total (XPF)</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for facture in factures %}
                            <tr>
                                <td>{{ facture.no_facture }}</td>
                                <td>{{ facture.personnel.dn }}</td>
                                <td>{{ facture.personnel.nom }}</td>
                                <td>{{ facture.personnel.prenom }}</td>
                                <td>{{ facture.total }}</td>
                                <td>
                                    <span class="tag {% if facture.paiement %}tag--success{% else %}tag--danger{% endif %}">{% if facture.paiement %}Pay√©e{% else %}Non pay√©e{% endif %}</span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="empty-state">Aucune facture rattach√©e √† ce bordereau.</p>
            {% endif %}
        </section>
    {% endif %}
{% endblock %}

{% extends 'expertise/layout.html' %}
{% block title %}Factures par compagnie{% endblock %}
{% block page_icon %}‚úàÔ∏è{% endblock %}
{% block page_title %}Factures par compagnie{% endblock %}
{% block page_subtitle %}S√©lectionnez un transporteur et consultez les factures associ√©es.{% endblock %}

{% block content %}
    <section class="card">
        <form method="get">
            <div class="form-grid">
                <div class="form-field">
                    <label for="compagnie-select">Compagnie a√©rienne</label>
                    <select id="compagnie-select" name="compagnie" onchange="this.form.submit()">
                        <option value="">-- S√©lectionner --</option>
                        {% for compagnie in compagnies %}
                            <option value="{{ compagnie.id }}" {% if selected_compagnie and compagnie.id == selected_compagnie.id %}selected{% endif %}>
                                {{ compagnie.nom }} ({{ compagnie.iata }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <noscript>
                    <div class="actions">
                        <button type="submit">Afficher</button>
                    </div>
                </noscript>
            </div>
        </form>
    </section>

    {% if selected_compagnie %}
        <section class="card">
            <h2>{{ selected_compagnie.nom }}</h2>
            {% if factures %}
                <form method="get" class="form-grid">
                    <input type="hidden" name="compagnie" value="{{ selected_compagnie.id }}">
                    <div class="form-field">
                        <label for="facture-select">Num√©ro de facture</label>
                        <select id="facture-select" name="facture" onchange="this.form.submit()">
                            <option value="">-- S√©lectionner --</option>
                            {% for facture in factures %}
                                <option value="{{ facture.no_facture }}" {% if selected_facture and selected_facture.no_facture == facture.no_facture %}selected{% endif %}>
                                    {{ facture.no_facture }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <noscript>
                        <div class="actions">
                            <button type="submit">Afficher</button>
                        </div>
                    </noscript>
                </form>
            {% else %}
                <p class="empty-state">Aucune facture disponible pour cette compagnie.</p>
            {% endif %}
        </section>
    {% endif %}

    {% if selected_facture %}
        <section class="card">
            <h2>Facture {{ selected_facture.no_facture }}</h2>
            <div class="tags">
                <span class="tag">Total : {{ selected_facture.total }} XPF</span>
                <span class="tag {% if selected_facture.paiement %}tag--success{% else %}tag--danger{% endif %}">{{ statut_label }}</span>
            </div>
            <ul class="data-list data-list--spaced">
                <li class="data-list__item"><span class="data-list__label">Nom</span><span class="data-list__value">{{ selected_facture.personnel.nom }}</span></li>
                <li class="data-list__item"><span class="data-list__label">Pr√©nom</span><span class="data-list__value">{{ selected_facture.personnel.prenom }}</span></li>
                <li class="data-list__item"><span class="data-list__label">Compagnie</span><span class="data-list__value">{% if selected_facture.personnel.compagnie %}{{ selected_facture.personnel.compagnie.nom }}{% else %}‚Äî{% endif %}</span></li>
            </ul>
            <form method="post" action="{% url 'toggle_facture_paiement' selected_facture.pk %}" class="actions actions--top">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn {% if selected_facture.paiement %}btn-secondary{% endif %}">
                    {% if selected_facture.paiement %}‚úÖ Marquer en attente{% else %}üí∏ Marquer comme pay√©{% endif %}
                </button>
            </form>
        </section>
    {% endif %}
{% endblock %}
